// ready-layer/prisma/schema.prisma
//
// Prisma schema for Requiem enterprise dashboard.
// Provider: PostgreSQL (Supabase in production, local for dev).
//
// INVARIANT: All tables are tenant-scoped via tenant_id.
// INVARIANT: No direct engine calls from Prisma queries;
//            engine data comes through the Node API boundary.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Audit Log ────────────────────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  actorId    String   @map("actor_id")
  action     String
  resourceId String?  @map("resource_id")
  traceId    String   @map("trace_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([tenantId, createdAt])
  @@map("audit_logs")
}

// ─── AI Cost Records ──────────────────────────────────────────────────────────

model AiCostRecord {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  actorId      String   @map("actor_id")
  provider     String
  model        String
  inputTokens  Int      @map("input_tokens")
  outputTokens Int      @map("output_tokens")
  costCents    Int      @map("cost_cents")
  latencyMs    Int      @map("latency_ms")
  traceId      String   @map("trace_id")
  phase        String?
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([tenantId, createdAt])
  @@map("ai_cost_records")
}

// ─── Replay Records ───────────────────────────────────────────────────────────

model ReplayRecord {
  id                   String    @id @default(cuid())
  hash                 String    @unique
  tenantId             String    @map("tenant_id")
  toolName             String    @map("tool_name")
  toolVersion          String    @map("tool_version")
  inputHash            String    @map("input_hash")
  integrity            String
  createdAt            DateTime  @default(now()) @map("created_at")

  // Microfracture Suite: Run Identity fields
  runId                String?   @unique @map("run_id")
  inputFingerprint     String?   @map("input_fingerprint")
  outputFingerprint    String?   @map("output_fingerprint")
  executionFingerprint String?   @map("execution_fingerprint")
  replayVerified       Boolean   @default(false) @map("replay_verified")
  replayMatchPercent   Int       @default(0) @map("replay_match_percent")
  policyDecisions      Json?     @map("policy_decisions")
  graphDigest          String?   @map("graph_digest")

  @@index([tenantId, hash])
  @@index([tenantId, runId])
  @@index([tenantId, createdAt])
  @@map("replay_records")
}

// ─── Run Lineage (DAG edges) ──────────────────────────────────────────────────

model RunEdge {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  parentRunId  String   @map("parent_run_id")
  childRunId   String   @map("child_run_id")
  reason       String
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([tenantId, parentRunId, childRunId])
  @@index([tenantId, parentRunId])
  @@index([tenantId, childRunId])
  @@map("run_edges")
}

// ─── Run Diffs (deterministic comparison cache) ─────────────────────────────────

model RunDiff {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  runA        String   @map("run_a")
  runB        String   @map("run_b")
  diffJson    Json     @map("diff_json")
  diffDigest  String   @map("diff_digest")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([tenantId, runA, runB])
  @@index([tenantId, runA])
  @@index([tenantId, runB])
  @@map("run_diffs")
}

// ─── Run Policy Simulations ───────────────────────────────────────────────────

model RunPolicySimulation {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  runId      String   @map("run_id")
  policyName String   @map("policy_name")
  resultJson Json     @map("result_json")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([tenantId, runId, policyName])
  @@index([tenantId, runId])
  @@map("run_policy_simulations")
}

// ─── Run Shares (share tokens for runs and diffs) ───────────────────────────────

model RunShare {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  subjectType     String    @map("subject_type")
  subjectA        String    @map("subject_a")
  subjectB        String?   @map("subject_b")
  token           String    @unique
  tokenHash       String    @unique @map("token_hash")
  scope           String    // 'public' | 'org'
  expiresAt       DateTime  @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  revokedAt       DateTime? @map("revoked_at")
  redactionLevel  String    @default("safe") @map("redaction_level")

  @@index([tenantId, subjectType, subjectA])
  @@index([tenantId, subjectType, subjectA, subjectB])
  @@index([tokenHash])
  @@map("run_shares")
}

// ─── Run Drift Events ───────────────────────────────────────────────────────────

model RunDriftEvent {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  baselineRunId  String   @map("baseline_run_id")
  comparedRunId  String   @map("compared_run_id")
  driftJson      Json     @map("drift_json")
  severityScore  Int      @default(0) @map("severity_score")
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([tenantId, baselineRunId, comparedRunId])
  @@index([tenantId, baselineRunId])
  @@index([tenantId, comparedRunId])
  @@map("run_drift_events")
}

// ─── Usage Rollups ──────────────────────────────────────────────────────────────

model UsageRollup {
  id               String   @id @default(cuid())
  tenantId         String   @map("tenant_id")
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  runsCount        Int      @default(0) @map("runs_count")
  replayStorageBytes Int    @default(0) @map("replay_storage_bytes")
  policyEvalsCount Int      @default(0) @map("policy_evals_count")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, periodStart])
  @@index([tenantId, periodStart])
  @@map("usage_rollups")
}

// ─── Learning Signals ────────────────────────────────────────────────────────────
// Signals captured during runtime execution for learning analysis.

model LearningSignal {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  runId        String?  @map("run_id")
  category     String   // build_failure|drift|policy_violation|replay_mismatch|test_failure|schema_gap|skill_gap|rollback_event|cost_spike|fairness_violation
  metadataJson Json?    @map("metadata_json")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([tenantId, category])
  @@index([tenantId, runId])
  @@index([tenantId, createdAt])
  @@map("learning_signals")
}

// ─── Learning Diagnoses ──────────────────────────────────────────────────────────
// Deterministic diagnoses mapped from signals.

model LearningDiagnosis {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  signalIds     String[] @map("signal_ids") // Array of signal IDs linked to this diagnosis
  rootCause     String   // prompt_gap|skill_gap|schema_gap|config_gap|policy_gap|strategic_misalignment|economic_misalignment
  confidenceScore Int    @default(0) @map("confidence_score") // Deterministic integer based on threshold counts
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([tenantId, rootCause])
  @@index([tenantId, createdAt])
  @@map("learning_diagnoses")
}

// ─── Learning Patches ─────────────────────────────────────────────────────────────
// Patch proposals generated from diagnoses.

model LearningPatch {
  id               String   @id @default(cuid())
  tenantId         String   @map("tenant_id")
  diagnosisId      String   @map("diagnosis_id")
  patchType        String   @map("patch_type") // skill_update|prompt_update|schema_update|config_update|branch_plan|rollback_plan|cost_model_update|fairness_policy_update
  targetFiles      String[] @map("target_files")
  patchDiffJson    Json?    @map("patch_diff_json")
  rollbackPlanJson Json?   @map("rollback_plan_json")
  status           String   @default("proposed") @map("status") // proposed|applied|rejected
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([tenantId, diagnosisId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("learning_patches")
}

// ─── Symmetry Metrics ─────────────────────────────────────────────────────────────
// Deterministic symmetry metrics for technical and strategic tracking.

model SymmetryMetric {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  metricName    String   @map("metric_name") // failure_recurrence_rate|drift_severity_score|replay_mismatch_rate|time_to_green|rollback_frequency|skill_coverage_ratio|instruction_coverage_score|burn_rate|cost_per_verified_run|replay_efficiency_ratio|fairness_index
  metricValue   Float    @map("metric_value")
  periodStart   DateTime @map("period_start")
  periodEnd     DateTime @map("period_end")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([tenantId, metricName])
  @@index([tenantId, periodStart])
  @@map("symmetry_metrics")
}

// ─── Economic Events ──────────────────────────────────────────────────────────────
// Detailed economic event tracking.

model EconomicEvent {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  runId          String?  @map("run_id")
  eventType      String   @map("event_type") // execution|replay_storage|policy_eval|drift_analysis
  resourceUnits  Int       @default(0) @map("resource_units")
  costUnits      Int       @default(0) @map("cost_units")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([tenantId, eventType])
  @@index([tenantId, runId])
  @@index([tenantId, createdAt])
  @@map("economic_events")
}

// ─── Economic Rollups ─────────────────────────────────────────────────────────────
// Periodic economic aggregation.

model EconomicRollup {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  periodStart        DateTime @map("period_start")
  periodEnd          DateTime @map("period_end")
  totalRuns          Int      @default(0) @map("total_runs")
  totalCostUnits     Int      @default(0) @map("total_cost_units")
  totalStorageUnits  Int      @default(0) @map("total_storage_units")
  totalPolicyUnits   Int      @default(0) @map("total_policy_units")
  burnRate           Float    @default(0.0) @map("burn_rate")
  createdAt          DateTime @default(now()) @map("created_at")

  @@unique([tenantId, periodStart])
  @@index([tenantId, periodStart])
  @@map("economic_rollups")
}

// ─── Economic Alerts ───────────────────────────────────────────────────────────────
// Deterministic alerts for economic anomalies.

model EconomicAlert {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  alertType     String   @map("alert_type") // burn_spike|storage_spike|policy_spike|fairness_violation
  severity      String   // low|medium|high|critical
  metadataJson  Json?    @map("metadata_json")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([tenantId, alertType])
  @@index([tenantId, severity])
  @@index([tenantId, createdAt])
  @@map("economic_alerts")
}
