name: ci

on:
  push:
  pull_request:
  schedule:
    # ASAN/UBSAN nightly: 02:00 UTC (Phase L)
    - cron: '0 2 * * *'
    # TSAN weekly: Sunday 03:00 UTC (Phase L)
    - cron: '0 3 * * 0'
    # Fuzz nightly: 03:30 UTC (time-boxed 10 min)
    - cron: '30 3 * * *'

jobs:
  # ---------------------------------------------------------------------------
  # Primary build + test (Linux + Windows)
  # ---------------------------------------------------------------------------
  build-test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: configure git hooks (Linux)
        if: runner.os == 'Linux'
        run: git config core.hooksPath .githooks
      - name: deps (ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y cmake g++ libssl-dev libzstd-dev python3
      - name: deps (windows)
        if: runner.os == 'Windows'
        run: choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
      - name: verify (build + test)
        run: ./scripts/verify.sh
      - name: generate golden corpus (post-build)
        if: runner.os == 'Linux'
        run: ./scripts/generate_golden_corpus.sh
      - name: upload golden corpus digests
        if: runner.os == 'Linux' && always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-corpus-digests
          path: testdata/golden/*.expected_digest
          if-no-files-found: warn
      - name: contract
        if: runner.os == 'Linux'
        run: ./scripts/verify_contract.sh
      - name: smoke
        if: runner.os == 'Linux'
        run: ./scripts/verify_smoke.sh
      - name: bench
        if: runner.os == 'Linux'
        run: ./scripts/verify_bench.sh
      - name: drift
        if: runner.os == 'Linux'
        run: ./scripts/verify_drift.sh
      - name: lint
        if: runner.os == 'Linux'
        run: ./scripts/verify_lint.sh
      - name: hash backend gate (linux)
        if: runner.os == 'Linux'
        run: ./scripts/verify_hash_backend.sh
      - name: hash backend gate (windows)
        if: runner.os == 'Windows'
        run: ./scripts/verify_hash_backend.ps1
      - name: secrets scan
        if: runner.os == 'Linux'
        run: ./scripts/verify_secrets.sh
      - name: protocol gate
        if: runner.os == 'Linux'
        run: ./scripts/verify_protocol.sh
      - name: security gate
        if: runner.os == 'Linux'
        run: ./scripts/verify_security.sh
      - name: CAS gate
        if: runner.os == 'Linux'
        run: ./scripts/verify_cas.sh
      - name: determinism gate (golden corpus + 200x + concurrent)
        if: runner.os == 'Linux'
        run: ./scripts/verify_determinism.sh
      - name: upload determinism report
        if: runner.os == 'Linux' && always()
        uses: actions/upload-artifact@v4
        with:
          name: determinism-report
          path: artifacts/reports/determinism_report.json
          if-no-files-found: warn
      - name: persona coverage gate (Phase A+E)
        if: runner.os == 'Linux'
        run: ./scripts/verify_personas.sh
      - name: version contracts gate (Phase G)
        if: runner.os == 'Linux'
        run: ./scripts/verify_version_contracts.sh
      - name: compat matrix gate (Phase 10)
        if: runner.os == 'Linux'
        run: ./scripts/verify_compat_matrix.sh
      - name: chaos gate (Phase 12)
        if: runner.os == 'Linux'
        run: ./scripts/verify_chaos.sh
      - name: upload chaos report
        if: runner.os == 'Linux' && always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-report
          path: artifacts/reports/chaos_report.json
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Governance gates (Linux only — no engine build required)
  # ---------------------------------------------------------------------------
  governance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for diff-based checks
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y python3
      - name: boundaries gate
        run: ./scripts/verify_boundaries.sh
      - name: deps gate
        run: ./scripts/verify_deps.sh
      - name: snapshot diff gate (fail on unapproved new dep)
        run: ./scripts/verify_snapshot_diff.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
      - name: migrations gate
        run: ./scripts/verify_migrations.sh
      - name: routes gate (static)
        run: ./scripts/verify_routes.sh
      - name: prompt lock gate
        run: ./scripts/verify_prompt_lock.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
      - name: policy gate (Phase 1)
        run: ./scripts/verify_policy.sh
      - name: policy contract verification (Phase 3)
        run: bash scripts/verify_policy_contract.sh
      - name: feature flags gate (Phase 4)
        run: ./scripts/verify_flags.sh
      - name: compat matrix gate (Phase 10)
        run: ./scripts/verify_compat_matrix.sh
      - name: supply chain gate (Phase 7)
        run: ./scripts/verify_supplychain.sh
      - name: claims enforcement gate
        run: ./scripts/verify_claims.sh
      - name: upload governance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-reports
          path: |
            artifacts/reports/deps_snapshot.json
            artifacts/reports/migration_audit.json
          if-no-files-found: warn

  # ---------------------------------------------------------------------------
  # AI layer unit tests (node:test) — Phase 6
  # ---------------------------------------------------------------------------
  ai-unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
      - name: Validate golden corpus JSON
        run: |
          node -e "JSON.parse(require('fs').readFileSync('testdata/golden/exec_request_canon.json'))"
          node -e "JSON.parse(require('fs').readFileSync('testdata/golden/policy_decision_canon.json'))"
          node -e "JSON.parse(require('fs').readFileSync('testdata/golden/budget_state_canon.json'))"
      - name: Validate contract JSON files
        run: |
          node -e "JSON.parse(require('fs').readFileSync('contracts/determinism.contract.json'))"
          node -e "JSON.parse(require('fs').readFileSync('contracts/deps.allowlist.json'))"
          node -e "JSON.parse(require('fs').readFileSync('contracts/migration.policy.json'))"
          node -e "JSON.parse(require('fs').readFileSync('contracts/compat.matrix.json'))"
      - name: Run AI layer unit tests (node:test)
        run: |
          node --test packages/ai/src/policy/__tests__/determinism.test.ts
          node --test packages/ai/src/policy/__tests__/adversarial_policy.test.ts
          node --test packages/ai/src/eval/__tests__/eval_cases.test.ts
          node --test packages/ai/src/tools/__tests__/adversarial.test.ts
          node --test wrapper.test.ts
      - name: Verify differentiator infrastructure
        run: node --test packages/ai/src/policy/__tests__/differentiators.test.ts

  # ---------------------------------------------------------------------------
  # Ready Layer typecheck + lint + build (Node.js / pnpm)
  # ---------------------------------------------------------------------------
  ready-layer-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Fail if required env missing
        run: |
          MISSING=0
          if [ -z "$DATABASE_URL" ]; then
            echo "❌ DATABASE_URL is not set"
            MISSING=1
          fi
          if [ -z "$DIRECT_DATABASE_URL" ]; then
            echo "❌ DIRECT_DATABASE_URL is not set"
            MISSING=1
          fi
          if [ "$MISSING" -eq 1 ]; then
            echo "Required secrets are missing. Set DATABASE_URL and DIRECT_DATABASE_URL in GitHub Actions secrets."
            exit 1
          fi
          echo "✅ Required environment variables present"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
      - name: install deps
        run: pnpm install --frozen-lockfile
      - name: prisma validate
        run: cd ready-layer && pnpm run prisma:validate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
      - name: prisma generate
        run: cd ready-layer && pnpm run prisma:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
      - name: lint
        run: pnpm run verify:lint
      - name: typecheck
        run: pnpm run typecheck
      - name: boundaries
        run: pnpm run verify:boundaries
      - name: build web
        run: pnpm run build:web
      - name: secrets scan
        run: bash scripts/verify-secrets.sh
      - name: verify:root
        run: bash scripts/verify-root.sh
      - name: Install Playwright browsers
        run: pnpm playwright install --with-deps chromium
      - name: Run Playwright tests
        run: cd ready-layer && pnpm run test:e2e
        env:
          CI: true
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # ---------------------------------------------------------------------------
  # Dependency graph artifacts (nightly, Linux)
  # ---------------------------------------------------------------------------
  dep-graph:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y cmake g++ libssl-dev python3 graphviz
      - name: build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DREQUIEM_WITH_ZSTD=OFF
          cmake --build build -j
      - name: generate C++ dep snapshot
        run: |
          python3 - <<'EOF'
          import subprocess, json, os, datetime
          result = {"schema": "cpp_dep_graph_v1", "generated_at": datetime.datetime.utcnow().isoformat()+"Z", "vendored": [], "system": []}
          if os.path.isdir("third_party"):
              result["vendored"] = sorted(os.listdir("third_party"))
          cmake_out = subprocess.run(["cmake", "--build", "build", "--target", "help"], capture_output=True, text=True)
          result["build_targets"] = [l.strip() for l in cmake_out.stdout.splitlines() if l.startswith("...")]
          os.makedirs("artifacts/reports", exist_ok=True)
          with open("artifacts/reports/cpp_dep_graph.json", "w") as f:
              json.dump(result, f, indent=2)
          print("Generated artifacts/reports/cpp_dep_graph.json")
          EOF
      - name: verify:deps
        run: ./scripts/verify_deps.sh
      - name: upload dep graph
        uses: actions/upload-artifact@v4
        with:
          name: dep-graph
          path: |
            artifacts/reports/cpp_dep_graph.json
            artifacts/reports/deps_snapshot.json

  # ---------------------------------------------------------------------------
  # ASAN nightly — Phase L
  # ---------------------------------------------------------------------------
  asan-nightly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y cmake clang libssl-dev
      - name: build (ASAN)
        run: |
          mkdir -p build-asan && cd build-asan
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DREQUIEM_WITH_ZSTD=OFF \
            -DREQUIEM_ASAN=ON \
            -DREQUIEM_BUILD_C_API=OFF \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++
          make -j$(nproc) requiem_tests requiem
      - name: run tests (ASAN)
        run: |
          cd build-asan
          ASAN_OPTIONS=detect_leaks=1:abort_on_error=1 ./requiem_tests
      - name: smoke (ASAN)
        run: REQUIEM_BIN=./build-asan/requiem ./scripts/verify_smoke.sh

  # ---------------------------------------------------------------------------
  # UBSAN nightly — Phase L
  # ---------------------------------------------------------------------------
  ubsan-nightly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y cmake clang libssl-dev
      - name: build (UBSAN)
        run: |
          mkdir -p build-ubsan && cd build-ubsan
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DREQUIEM_WITH_ZSTD=OFF \
            -DREQUIEM_UBSAN=ON \
            -DREQUIEM_BUILD_C_API=OFF \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++
          make -j$(nproc) requiem_tests requiem
      - name: run tests (UBSAN)
        run: |
          cd build-ubsan
          UBSAN_OPTIONS=halt_on_error=1:print_stacktrace=1 ./requiem_tests

  # ---------------------------------------------------------------------------
  # TSAN weekly — Phase L
  # ---------------------------------------------------------------------------
  tsan-weekly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y cmake clang libssl-dev
      - name: build (TSAN)
        run: |
          mkdir -p build-tsan && cd build-tsan
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DREQUIEM_WITH_ZSTD=OFF \
            -DREQUIEM_TSAN=ON \
            -DREQUIEM_BUILD_C_API=OFF \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++
          make -j$(nproc) requiem_tests
      - name: run tests (TSAN)
        run: |
          cd build-tsan
          TSAN_OPTIONS=halt_on_error=1 ./requiem_tests

  # ---------------------------------------------------------------------------
  # Fuzz nightly — time-boxed 10 min (Phase L extension)
  # ---------------------------------------------------------------------------
  fuzz-nightly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y cmake clang libssl-dev
      - name: build (fuzz)
        run: |
          mkdir -p build-fuzz && cd build-fuzz
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DREQUIEM_WITH_ZSTD=OFF \
            -DREQUIEM_FUZZ=ON \
            -DREQUIEM_BUILD_C_API=OFF \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++
          make -j$(nproc) fuzz_protocol || echo "fuzz target optional — skip if not configured"
      - name: fuzz protocol (10 min time-boxed)
        run: |
          if [ -f build-fuzz/fuzz_protocol ]; then
            mkdir -p fuzz-corpus
            timeout 600 ./build-fuzz/fuzz_protocol fuzz-corpus \
              -max_total_time=600 \
              -print_final_stats=1 \
              -jobs=2 -workers=2 || true
          else
            echo "SKIP: fuzz_protocol binary not built"
          fi
      - name: upload fuzz artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus
          path: fuzz-corpus/
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Formal spec model checking — nightly (Phase 11)
  # ---------------------------------------------------------------------------
  formal-nightly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y python3
      - name: verify formal specs present
        run: |
          for spec in formal/CAS.tla formal/Protocol.tla formal/Replay.tla formal/Determinism.tla formal/model_checker.py; do
            [ -f "$spec" ] || { echo "FAIL: $spec not found"; exit 1; }
          done
      - name: run bounded model checker
        run: python3 formal/model_checker.py --bound 50 --verbose
      - name: formal gate (full)
        run: ./scripts/verify_formal.sh

  # ---------------------------------------------------------------------------
  # Chaos engineering nightly — fault injection suite (Phase 12)
  # ---------------------------------------------------------------------------
  chaos-nightly:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - name: deps
        run: sudo apt-get update && sudo apt-get install -y cmake g++ libssl-dev python3
      - name: build (with chaos harness)
        run: |
          cmake -S . -B build-chaos \
            -DCMAKE_BUILD_TYPE=Debug \
            -DREQUIEM_WITH_ZSTD=OFF \
            -DREQUIEM_BUILD_C_API=OFF \
            -DREQUIEM_BUILD_CHAOS=ON
          cmake --build build-chaos -j$(nproc) --target chaos_harness || \
            echo "chaos_harness target not available — script-level check only"
      - name: run chaos harness
        run: |
          mkdir -p artifacts/reports
          if [ -f build-chaos/chaos_harness ]; then
            ./build-chaos/chaos_harness
          else
            echo "INFO: chaos_harness binary not built — running script-level validation"
          fi
      - name: chaos gate
        run: ./scripts/verify_chaos.sh
      - name: upload chaos report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-report-nightly
          path: artifacts/reports/chaos_report.json
          if-no-files-found: ignore
